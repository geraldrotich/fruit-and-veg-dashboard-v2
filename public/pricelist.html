function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById(tab).classList.add('active');
}

function addProduct(e) {
  e.preventDefault();
  const name = document.getElementById("product-name").value.trim();
  const type = document.getElementById("product-type").value;
  const vendor = document.getElementById("vendor-name").value.trim();
  const unit = document.getElementById("unit").value.trim();
  const price = parseFloat(document.getElementById("price").value);

  db.collection("products").add({
    name,
    type,
    vendor,
    unit,
    price
  }).then(() => {
    alert("Product added!");
    loadProducts();
    e.target.reset();
  });
}

function addVendor(e) {
  e.preventDefault();
  const name = document.getElementById("new-vendor-name").value.trim();
  db.collection("vendors").add({ name }).then(() => {
    alert("Vendor added!");
    loadVendors();
    e.target.reset();
  });
}

function loadProducts() {
  db.collection("products").orderBy("name").get().then(snapshot => {
    const container = document.getElementById("product-list");
    container.innerHTML = "";
    const products = {};

    snapshot.forEach(doc => {
      const data = doc.data();
      if (!products[data.name]) products[data.name] = [];
      products[data.name].push(data);
    });

    Object.keys(products).forEach(productName => {
      const productGroup = products[productName];
      const tagClass = productGroup[0].type;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<strong>${productName}</strong> <span class="tag ${tagClass}">${tagClass}</span>`;

      card.addEventListener("click", () => {
        card.innerHTML = `<strong>${productName}</strong> <span class="tag ${tagClass}">${tagClass}</span>`;
        productGroup.forEach(item => {
          card.innerHTML += `<div class="vendor-entry">Vendor: ${item.vendor}<br>Unit: ${item.unit}<br>Price: ${item.price}</div>`;
        });
      });

      container.appendChild(card);
    });
  });
}

function loadVendors() {
  db.collection("vendors").get().then(vendorSnap => {
    const vendorList = document.getElementById("vendor-list");
    vendorList.innerHTML = "";

    vendorSnap.forEach(vendorDoc => {
      const vendorData = vendorDoc.data();
      const vendorCard = document.createElement("div");
      vendorCard.className = "card";
      vendorCard.textContent = vendorData.name;

      vendorCard.addEventListener("click", () => {
        db.collection("products").where("vendor", "==", vendorData.name).get().then(prodSnap => {
          vendorCard.innerHTML = `<strong>${vendorData.name}</strong>`;
          prodSnap.forEach(prodDoc => {
            const item = prodDoc.data();
            vendorCard.innerHTML += `<div class="vendor-entry">Product: ${item.name}<br>Unit: ${item.unit}<br>Price: ${item.price}</div>`;
          });
        });
      });

      vendorList.appendChild(vendorCard);
    });
  });
}

// Initial load
window.onload = () => {
  loadProducts();
  loadVendors();
};
